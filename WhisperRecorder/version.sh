#!/bin/bash

# WhisperRecorder Version Management Script

CURRENT_VERSION=$(cat VERSION 2>/dev/null || echo "1.0.0")

show_help() {
    echo "WhisperRecorder Version Manager"
    echo ""
    echo "Usage: $0 [command] [version]"
    echo ""
    echo "Commands:"
    echo "  current           Show current version"
    echo "  set <version>     Set specific version (e.g., 1.2.3)"
    echo "  bump major        Bump major version (1.0.0 ‚Üí 2.0.0)"
    echo "  bump minor        Bump minor version (1.0.0 ‚Üí 1.1.0)"  
    echo "  bump patch        Bump patch version (1.0.0 ‚Üí 1.0.1)"
    echo "  tag               Create git tag for current version"
    echo "  tag-release       Create git tag and push (trigger GitHub workflow)"
    echo "  release           Local release (build, package, changelog, commit)"
    echo "  publish <type>    Full workflow (bump, build, changelog, GitHub release)"
    echo ""
    echo "Local workflow:"
    echo "  release           Build current version, update changelog, commit"
    echo ""
    echo "GitHub workflow:"
    echo "  publish major     Bump major ‚Üí build ‚Üí changelog ‚Üí GitHub release"
    echo "  publish minor     Bump minor ‚Üí build ‚Üí changelog ‚Üí GitHub release"
    echo "  publish patch     Bump patch ‚Üí build ‚Üí changelog ‚Üí GitHub release"
    echo ""
    echo "Current version: $CURRENT_VERSION"
}

bump_version() {
    local type=$1
    local major minor patch
    
    IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
    
    case $type in
        major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
        minor)
            minor=$((minor + 1))
            patch=0
            ;;
        patch)
            patch=$((patch + 1))
            ;;
        *)
            echo "‚ùå Invalid bump type: $type"
            exit 1
            ;;
    esac
    
    local new_version="$major.$minor.$patch"
    echo "$new_version" > VERSION
    echo "‚úÖ Version bumped: $CURRENT_VERSION ‚Üí $new_version"
}

set_version() {
    local version=$1
    
    # Validate version format
    if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo "‚ùå Invalid version format. Use semver (e.g., 1.2.3)"
        exit 1
    fi
    
    echo "$version" > VERSION
    echo "‚úÖ Version set to: $version"
}

create_tag() {
    local version=$(cat VERSION)
    local tag="v$version"
    
    echo "üè∑Ô∏è  Creating git tag: $tag"
    
    if git tag -l | grep -q "^$tag$"; then
        echo "‚ùå Tag $tag already exists"
        exit 1
    fi
    
    git tag -a "$tag" -m "WhisperRecorder v$version"
    echo "‚úÖ Created tag: $tag"
}

update_changelog() {
    local version=$1
    local date=$(date +%Y-%m-%d)
    
    if [ ! -f "../CHANGELOG.md" ]; then
        echo "‚ö†Ô∏è  CHANGELOG.md not found, skipping changelog update"
        return 0
    fi
    
    echo "üìù Updating CHANGELOG.md..."
    
    # Replace [Unreleased] with the new version
    sed -i.bak "s/## \[Unreleased\]/## [$version] - $date/" "../CHANGELOG.md"
    
    # Add new Unreleased section at the top using temp file approach
    echo "## [Unreleased]" > temp_section.md
    echo "" >> temp_section.md
    echo "### Added" >> temp_section.md
    echo "" >> temp_section.md
    echo "### Fixed" >> temp_section.md
    echo "" >> temp_section.md
    echo "### Changed" >> temp_section.md
    echo "" >> temp_section.md
    
    # Insert new unreleased section
    head -n $(grep -n "## \[$version\]" "../CHANGELOG.md" | cut -d: -f1 | head -1) "../CHANGELOG.md" > temp_changelog.md
    head -n -1 temp_changelog.md > temp_changelog2.md
    cat temp_section.md >> temp_changelog2.md
    tail -n +$(grep -n "## \[$version\]" "../CHANGELOG.md" | cut -d: -f1 | head -1) "../CHANGELOG.md" >> temp_changelog2.md
    mv temp_changelog2.md "../CHANGELOG.md"
    
    rm temp_section.md temp_changelog.md 2>/dev/null || true
    rm "../CHANGELOG.md.bak" 2>/dev/null || true
    
    echo "‚úÖ CHANGELOG.md updated"
}

generate_release_notes() {
    local version=$1
    
    echo "üìã Generating release notes..."
    
    # Start release notes
    echo "# WhisperRecorder v$version" > release_notes.md
    echo "" >> release_notes.md
    
    # Extract changes from CHANGELOG.md if it exists
    if [ -f "../CHANGELOG.md" ]; then
        echo "## What's New" >> release_notes.md
        echo "" >> release_notes.md
        
        # Extract content for this version
        if grep -q "## \[$version\]" "../CHANGELOG.md"; then
            echo "### Changes in this release:" >> release_notes.md
            # Extract content between this version and next version section
            sed -n "/## \[$version\]/,/## \[/p" "../CHANGELOG.md" | sed '$d' | tail -n +2 >> release_notes.md
        else
            echo "### Recent changes:" >> release_notes.md
            # Fallback to git commits since last tag
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
                git log --pretty=format:"- %s" $LAST_TAG..HEAD >> release_notes.md
            else
                echo "- Initial release" >> release_notes.md
            fi
        fi
    else
        # Fallback to git commits
        echo "## Changes" >> release_notes.md
        echo "" >> release_notes.md
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
            echo "### Changes since $LAST_TAG:" >> release_notes.md
            git log --pretty=format:"- %s" $LAST_TAG..HEAD >> release_notes.md
        else
            echo "- Initial release" >> release_notes.md
        fi
    fi

    echo "" >> release_notes.md
    echo "## üîì Important Security Notice" >> release_notes.md
    echo "" >> release_notes.md
    echo "**If you see \"WhisperRecorder is damaged and can't be opened\":**" >> release_notes.md
    echo "" >> release_notes.md
    echo "This happens because the app is not code-signed with Apple Developer ID. Choose one solution:" >> release_notes.md
    echo "" >> release_notes.md
    echo "**Option 1 - Terminal command:**" >> release_notes.md
    echo "\`\`\`bash" >> release_notes.md
    echo "xattr -d com.apple.quarantine /Applications/WhisperRecorder.app" >> release_notes.md
    echo "\`\`\`" >> release_notes.md
    echo "" >> release_notes.md
    echo "**Option 2 - Right-click method:**" >> release_notes.md
    echo "- Right-click WhisperRecorder.app ‚Üí \"Open\"" >> release_notes.md
    echo "- Click \"Open\" in the security dialog" >> release_notes.md
    echo "" >> release_notes.md
    echo "**Option 3 - System Preferences:**" >> release_notes.md
    echo "- System Preferences ‚Üí Security & Privacy ‚Üí General" >> release_notes.md
    echo "- Click \"Open Anyway\" next to WhisperRecorder message" >> release_notes.md
    echo "" >> release_notes.md
    echo "## üì¶ Installation" >> release_notes.md
    echo "" >> release_notes.md
    echo "1. Download \`WhisperRecorder-v$version-macOS-arm64.zip\`" >> release_notes.md
    echo "2. Unzip and move \`WhisperRecorder.app\` to Applications folder" >> release_notes.md
    echo "3. **If blocked by macOS:** Use one of the methods above ‚òùÔ∏è" >> release_notes.md
    echo "" >> release_notes.md
    echo "## Requirements" >> release_notes.md
    echo "" >> release_notes.md
    echo "- macOS 12.0+ (Monterey or later)" >> release_notes.md
    echo "- Apple Silicon (M1/M2/M3) Mac" >> release_notes.md
    echo "- Microphone access permission" >> release_notes.md
    echo "" >> release_notes.md
    echo "## Features" >> release_notes.md
    echo "" >> release_notes.md
    echo "- üéôÔ∏è Real-time voice recording and transcription" >> release_notes.md
    echo "- ü§ñ AI-powered text enhancement with multiple providers" >> release_notes.md
    echo "- üìã Auto-paste to active applications" >> release_notes.md
    echo "- üí¨ Smart toast notifications" >> release_notes.md
    echo "- ‚ö° Offline Whisper AI models" >> release_notes.md
    echo "- üåç Multiple target languages" >> release_notes.md
    
    echo "‚úÖ Release notes generated: release_notes.md"
}

create_github_release() {
    local version=$1
    local tag="v$version"
    local zip_file="WhisperRecorder-v$version-macOS-arm64.zip"
    
    # Check if GitHub CLI is installed
    if ! command -v gh &> /dev/null; then
        echo "‚ùå GitHub CLI (gh) not found. Install with: brew install gh"
        echo "   Or upload manually: https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\([^.]*\).*/\1/')/releases/new"
        return 1
    fi
    
    # Check if authenticated
    if ! gh auth status &> /dev/null; then
        echo "‚ùå Not authenticated with GitHub. Run: gh auth login"
        return 1
    fi
    
    # Check if ZIP file exists
    if [ ! -f "$zip_file" ]; then
        echo "‚ùå Release ZIP not found: $zip_file"
        return 1
    fi
    
    echo "üöÄ Creating GitHub release..."
    
    # Create release with ZIP attachment
    gh release create "$tag" "$zip_file" \
        --title "WhisperRecorder $version" \
        --notes-file release_notes.md \
        --latest
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ GitHub release created successfully!"
        echo "üåê View: https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\([^.]*\).*/\1/')/releases/latest"
    else
        echo "‚ùå Failed to create GitHub release"
        return 1
    fi
}

local_release() {
    local current_version=$(cat VERSION)
    
    echo "üî® Starting local release workflow"
    echo "================================="
    echo "üîµ Current version: $current_version"
    
    # Check if working directory is clean
    if ! git diff-index --quiet HEAD --; then
        echo "‚ùå Working directory not clean. Commit changes first."
        exit 1
    fi
    
    # Step 1: Build app
    echo ""
    echo "üî® Step 1/5: Building WhisperRecorder..."
    if ! ./whisper build; then
        echo "‚ùå Build failed"
        exit 1
    fi
    
    # Step 2: Create release package
    echo ""
    echo "üì¶ Step 2/5: Creating release package..."
    if ! echo "" | ./whisper release; then
        echo "‚ùå Release package creation failed"
        exit 1
    fi
    
    # Step 3: Rename ZIP with version
    echo ""
    echo "üìù Step 3/5: Renaming release package..."
    local zip_file="WhisperRecorder-v$current_version-macOS-arm64.zip"
    if [ -f "WhisperRecorder.zip" ]; then
        mv "WhisperRecorder.zip" "$zip_file"
        echo "‚úÖ Created: $zip_file"
    else
        echo "‚ùå WhisperRecorder.zip not found"
        exit 1
    fi
    
    # Step 4: Update CHANGELOG
    echo ""
    echo "üìù Step 4/5: Updating CHANGELOG.md..."
    update_changelog "$current_version"
    
    # Step 5: Commit changes
    echo ""
    echo "üíæ Step 5/5: Committing changes..."
    
    git add VERSION ../CHANGELOG.md
    git commit -m "Local release v$current_version

- Built and packaged WhisperRecorder.app
- Updated CHANGELOG.md with release date
- Created release package: $zip_file"
    
    echo ""
    echo "‚úÖ Local release completed!"
    echo "=========================="
    echo "üîµ Version: $current_version"
    echo "üì¶ Package: $zip_file"
    echo "üìù CHANGELOG.md updated"
    echo ""
    echo "üí° Next steps:"
    echo "  ‚Ä¢ Test the release: open WhisperRecorder.app"
    echo "  ‚Ä¢ For GitHub release: ./whisper version publish <type>"
    echo "  ‚Ä¢ Manual upload: GitHub ‚Üí Releases ‚Üí New release"
}

github_publish_workflow() {
    local bump_type=$1
    local start_version=$CURRENT_VERSION
    
    echo "üöÄ Starting GitHub publish workflow: $bump_type"
    echo "============================================="
    echo "üîµ Current version: $start_version"
    
    # Check if working directory is clean
    if ! git diff-index --quiet HEAD --; then
        echo "‚ùå Working directory not clean. Commit changes first."
        exit 1
    fi
    
    # Step 1: Bump version
    echo ""
    echo "üìà Step 1/7: Bumping version ($bump_type)..."
    bump_version "$bump_type"
    local new_version=$(cat VERSION)
    
    # Step 2: Build app
    echo ""
    echo "üî® Step 2/7: Building WhisperRecorder..."
    if ! ./whisper build; then
        echo "‚ùå Build failed"
        exit 1
    fi
    
    # Step 3: Create release package
    echo ""
    echo "üì¶ Step 3/7: Creating release package..."
    if ! echo "" | ./whisper release; then
        echo "‚ùå Release package creation failed"
        exit 1
    fi
    
    # Step 4: Rename ZIP with version
    echo ""
    echo "üìù Step 4/7: Renaming release package..."
    local zip_file="WhisperRecorder-v$new_version-macOS-arm64.zip"
    if [ -f "WhisperRecorder.zip" ]; then
        mv "WhisperRecorder.zip" "$zip_file"
        echo "‚úÖ Created: $zip_file"
    else
        echo "‚ùå WhisperRecorder.zip not found"
        exit 1
    fi
    
    # Step 5: Update CHANGELOG
    echo ""
    echo "üìù Step 5/7: Updating CHANGELOG.md..."
    update_changelog "$new_version"
    
    # Step 6: Generate release notes
    echo ""
    echo "üìã Step 6/7: Generating release notes..."
    generate_release_notes "$new_version"
    
    # Step 7: Commit and create GitHub release
    echo ""
    echo "üè∑Ô∏è  Step 7/7: Committing and creating GitHub release..."
    
    # Commit changes
    git add VERSION ../CHANGELOG.md
    git commit -m "Release v$new_version

- Bump version: $start_version ‚Üí $new_version
- Update CHANGELOG.md with release date
- Created release package: $zip_file"
    
    # Create tag
    create_tag
    
    # Push changes and tag
    git push origin HEAD
    git push origin "v$new_version"
    
    # Create GitHub release
    create_github_release "$new_version"
    
    # Cleanup
    rm -f release_notes.md
    
    echo ""
    echo "üéâ GitHub publish workflow completed!"
    echo "=================================="
    echo "üîµ Version: $start_version ‚Üí $new_version"
    echo "üì¶ Package: $zip_file"
    echo "üè∑Ô∏è  Tag: v$new_version"
    echo "üìù CHANGELOG.md updated"
    echo "üåê GitHub: https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\([^.]*\).*/\1/')/releases/latest"
}

simple_tag_release() {
    local version=$(cat VERSION)
    local tag="v$version"
    
    # Check if working directory is clean
    if ! git diff-index --quiet HEAD --; then
        echo "‚ùå Working directory not clean. Commit changes first."
        exit 1
    fi
    
    echo "üöÄ Creating tag release for v$version..."
    
    # Create tag
    create_tag
    
    # Push tag to trigger GitHub release
    echo "üì§ Pushing tag to GitHub..."
    git push origin "$tag"
    
    echo "‚úÖ Tag release v$version triggered!"
    echo "üåê Check: https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\([^.]*\).*/\1/')/actions"
}

case ${1:-help} in
    current)
        echo "Current version: $CURRENT_VERSION"
        ;;
    set)
        if [ -z "$2" ]; then
            echo "‚ùå Please specify version to set"
            exit 1
        fi
        set_version "$2"
        ;;
    bump)
        if [ -z "$2" ]; then
            echo "‚ùå Please specify bump type: major, minor, or patch"
            exit 1
        fi
        bump_version "$2"
        ;;
    tag)
        create_tag
        ;;
    tag-release)
        simple_tag_release
        ;;
    release)
        # Local release workflow
        local_release
        ;;
    publish)
        if [ -z "$2" ]; then
            echo "‚ùå Please specify bump type for GitHub publish"
            echo "Usage: ./whisper version publish <major|minor|patch>"
            exit 1
        else
            # GitHub publish workflow with bump type
            case "$2" in
                major|minor|patch)
                    github_publish_workflow "$2"
                    ;;
                *)
                    echo "‚ùå Invalid bump type: $2"
                    echo "Valid types: major, minor, patch"
                    exit 1
                    ;;
            esac
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        show_help
        exit 1
        ;;
esac 